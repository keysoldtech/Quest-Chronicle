<!-- 
  --- INDEX ---
  1.  METADATA & STYLESHEETS
  2.  MENU SCREEN (#menu-screen)
  3.  GAME SCREEN (#game-screen)
      - 3.1. GAME AREA (#game-area)
          - 3.1.1. DESKTOP LAYOUT
          - 3.1.2. MOBILE LAYOUT
      - 3.2. SHARED OVERLAYS & MODALS
  4.  SCRIPTS
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quest & Chronicle - Multiplayer Prototype</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=MedievalSharp&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    
    <!-- App Icons -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/dragon-icon.svg">
    <link rel="apple-touch-icon" href="/dragon-icon.svg">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Quest & Chronicle">
</head>
<body>
    <div class="background-animation"></div>

    <!-- INITIAL MENU SCREEN -->
    <div id="menu-screen" class="screen active">
        <div class="menu-container">
            <h1 class="game-title">Quest & Chronicle</h1>
            <p class="game-subtitle">stylized&optimized</p>
            
            <!-- Player Name Input -->
            <div class="menu-section">
                <label for="player-name-input">Your Name:</label>
                <input type="text" id="player-name-input" placeholder="Enter your name" maxlength="20">
            </div>
            
            <!-- Game Mode Selection -->
            <div class="menu-section">
                <h3>Select Game Mode</h3>
                <div class="mode-buttons">
                    <button class="mode-btn" data-mode="Beginner">
                        <span class="mode-title">Beginner</span>
                        <span class="mode-desc">Start with gear and resources</span>
                    </button>
                    <button class="mode-btn" data-mode="Advanced">
                        <span class="mode-title">Advanced</span>
                        <span class="mode-desc">Standard difficulty</span>
                    </button>
                    <button class="mode-btn" data-mode="Custom">
                        <span class="mode-title">Custom</span>
                        <span class="mode-desc">Configure your own settings</span>
                    </button>
                </div>
            </div>
            
            <!-- Custom Settings (Hidden by default) -->
            <div id="custom-settings" class="menu-section hidden">
                <h3>Custom Settings</h3>
                <div class="settings-grid">
                    <label>
                        <input type="checkbox" id="setting-weapon" checked>
                        Start with Weapon
                    </label>
                    <label>
                        <input type="checkbox" id="setting-armor" checked>
                        Start with Armor
                    </label>
                    <label>
                        Starting Items: 
                        <input type="number" id="setting-items" min="0" max="5" value="2">
                    </label>
                    <label>
                        Starting Spells: 
                        <input type="number" id="setting-spells" min="0" max="5" value="2">
                    </label>
                    <label>
                        Loot Drop Rate (%): 
                        <input type="number" id="setting-loot-rate" min="0" max="100" value="80">
                    </label>
                    <label>
                        <input type="checkbox" id="setting-discovery-rolls" checked>
                        Enable Discovery Rolls
                    </label>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="menu-section">
                <button id="create-room-btn" class="btn btn-primary" disabled>Create Game</button>
                <div class="or-divider">OR</div>
                <div class="join-section">
                    <input type="text" id="room-code-input" placeholder="Enter 4-letter room code" maxlength="4">
                    <button id="join-room-btn" class="btn btn-secondary">Join Game</button>
                </div>
            </div>
            
            <div id="menu-error" class="error-message hidden"></div>
            <p class="build-number-font-menu">v9.0.21 - Game Flow Fix</p>
        </div>
    </div>
    
    <!-- MAIN GAME SCREEN (Your existing game UI) -->
    <div id="game-screen" class="screen">
        <div id="game-area" class="game-area">
            
            <!-- ================= DESKTOP LAYOUT ================= -->
            <div class="game-area-desktop">
                <header class="game-header">
                    <div class="header-info">
                         <p class="turn-indicator-font" data-container="turn-indicator">Waiting for game to start...</p>
                         <div id="party-hope-meter-desktop" class="party-hope-meter-container hidden" data-container="party-hope-meter">
                            <span class="party-hope-label">Party Hope</span>
                            <div class="party-hope-meter">
                                <span class="material-symbols-outlined">stars</span>
                                <div class="progress-bar-wrapper">
                                    <div class="progress-bar hope">
                                        <div class="progress-bar-fill" data-container="party-hope-bar"></div>
                                    </div>
                                    <span class="progress-bar-text" id="party-hope-text-desktop"></span>
                                </div>
                            </div>
                        </div>
                        <div class="player-resources-container hidden" data-container="player-resources">
                             <div class="player-health-bar-container">
                                 <span class="material-symbols-outlined">favorite</span>
                                 <div class="progress-bar-wrapper">
                                     <div class="progress-bar health">
                                         <div class="progress-bar-fill" data-container="player-health-bar"></div>
                                     </div>
                                     <span class="progress-bar-text" data-container="player-health-text"></span>
                                 </div>
                             </div>
                             <p class="ap-counter" data-container="ap-counter"></p>
                        </div>
                         <p class="turn-counter">Round: <span data-container="turn-counter">0</span></p>
                    </div>
                     <div class="header-controls">
                        <p class="build-number-font">v9.0.21 - Game Flow Fix</p>
                        <div id="dm-controls" class="dm-controls hidden">
                             <button id="dm-play-monster-btn" class="btn btn-sm btn-secondary">Play Monster</button>
                        </div>
                        <div class="room-code-display">
                            <span>Room Code</span>
                            <p data-container="room-code">----</p>
                        </div>
                        <div class="header-menu">
                            <button id="menu-toggle-btn" class="btn btn-sm btn-icon"><span class="material-symbols-outlined">menu</span></button>
                            <div id="menu-dropdown" class="menu-dropdown hidden">
                                <button id="chat-toggle-btn" class="menu-item"><span class="material-symbols-outlined">chat</span>Chat & Log</button>
                                <button id="help-btn" class="menu-item"><span class="material-symbols-outlined">help</span>Game Guide</button>
                                <button id="join-voice-btn" class="menu-item"><span class="material-symbols-outlined">mic</span>Join Voice</button>
                                <button id="mute-voice-btn" class="menu-item hidden"><span class="material-symbols-outlined">mic_off</span>Mute</button>
                                <button id="leave-voice-btn" class="menu-item hidden"><span class="material-symbols-outlined">voice_over_off</span>Leave Voice</button>
                                <button id="leave-game-btn" class="menu-item danger"><span class="material-symbols-outlined">logout</span>Leave Game</button>
                            </div>
                        </div>
                    </div>
                </header>
    
                <aside id="players-list-container" class="players-panel panel">
                    <div id="player-list-display">
                        <h2 class="panel-header">Players</h2>
                        <div class="lobby-settings-display hidden" data-container="game-lobby-settings"></div>
                        <ul class="player-list" data-container="player-list"></ul>
                        <div class="lobby-controls hidden" data-container="lobby-controls">
                           <button class="btn btn-primary" data-container="start-game-btn" disabled>Start Game</button>
                        </div>
                    </div>
                    <div id="character-sheet-block">
                        <!-- Content for class selection or player stats will be rendered here -->
                    </div>
                </aside>
                
                <div id="main-game-area-wrapper">
                    <div class="world-event-banner hidden" data-container="world-event-display"></div>
                    <main id="game-board-container" class="board-panel panel">
                        <h2 class="panel-header">Game Board</h2>
                        <div class="card-container-row" data-container="board-cards"></div>
                    </main>
                    <footer id="hand-equipment-container" class="hand-panel panel">
                        <div class="player-hand-header">
                           <h2 class="panel-header">Your Hand & Equipment</h2>
                        </div>
                       <div class="hand-and-equipped-container">
                           <div class="equipped-items-container">
                               <h3 class="sub-header-font">Equipped</h3>
                               <div class="card-container-row" data-container="equipped-items"></div>
                           </div>
                           <div class="player-hand-container card-container-row" data-container="player-hand"></div>
                       </div>
                   </footer>
                </div>

                <aside class="info-tabs-panel panel">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="game-log-tab">Game Log</button>
                        <button class="tab-btn" data-tab="party-loot-tab">Party Discoveries</button>
                    </div>
                    <div id="game-log-tab" class="tab-content active">
                        <div class="log-content-area" data-container="game-log"></div>
                    </div>
                    <div id="party-loot-tab" class="tab-content">
                        <div class="card-container-row" data-container="party-loot"></div>
                    </div>
                </aside>
    
                <div id="chat-preview-container"></div>
                <div class="fixed-action-bar hidden" data-container="action-bar">
                    <button class="btn btn-special hidden" data-container="action-skill-challenge-btn">Challenge (1 AP)</button>
                    <button class="btn btn-secondary" data-container="action-guard-btn">Guard (1AP)</button>
                    <button class="btn btn-secondary" data-container="action-brief-respite-btn">Respite (1AP)</button>
                    <button class="btn btn-secondary" data-container="action-full-rest-btn">Rest (2AP)</button>
                    <button class="btn btn-primary" data-container="action-end-turn-btn">End Turn</button>
                </div>
            </div>
    
            <!-- ================= MOBILE LAYOUT ================= -->
            <div class="game-area-mobile">
                <header class="mobile-header">
                    <p class="turn-indicator-font" data-container="turn-indicator">Waiting...</p>
                    <div class="mobile-header-right-cluster">
                        <div class="mobile-resources">
                            <div id="party-hope-meter-mobile" class="party-hope-meter-container mobile hidden" data-container="party-hope-meter">
                                <span class="party-hope-label">Party Hope</span>
                                <div class="party-hope-meter mobile">
                                    <span class="material-symbols-outlined">stars</span>
                                    <span id="party-hope-text-mobile"></span>
                                </div>
                            </div>
                            <div class="player-resources-container mobile hidden" data-container="player-resources">
                                <div class="player-health-bar-container mobile">
                                    <span class="material-symbols-outlined">favorite</span>
                                    <div class="progress-bar-wrapper">
                                        <div class="progress-bar health">
                                            <div class="progress-bar-fill" data-container="player-health-bar"></div>
                                        </div>
                                        <span class="progress-bar-text" data-container="player-health-text"></span>
                                    </div>
                                </div>
                                <p class="ap-counter" data-container="ap-counter"></p>
                            </div>
                        </div>
                        <div class="mobile-header-controls">
                            <div class="room-code-display mobile">
                                <span>CODE</span>
                                <p data-container="room-code">----</p>
                            </div>
                            <div class="header-menu">
                                <button id="mobile-menu-toggle-btn" class="btn btn-sm btn-icon"><span class="material-symbols-outlined">menu</span></button>
                                <div id="mobile-menu-dropdown" class="menu-dropdown hidden">
                                    <button id="mobile-help-btn" class="menu-item"><span class="material-symbols-outlined">help</span>Game Guide</button>
                                    <button id="mobile-join-voice-btn" class="menu-item"><span class="material-symbols-outlined">mic</span>Voice</button>
                                    <button id="mobile-mute-voice-btn" class="menu-item hidden"><span class="material-symbols-outlined">mic_off</span>Mute</button>
                                    <button id="mobile-leave-voice-btn" class="menu-item hidden"><span class="material-symbols-outlined">voice_over_off</span>Leave</button>
                                    <button id="mobile-leave-game-btn" class="menu-item danger"><span class="material-symbols-outlined">logout</span>Leave Game</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                
                <main class="mobile-main">
                    <div class="world-event-banner hidden" data-container="world-event-display"></div>
                    <!-- Mobile Screen 1: Game (Board, Equipment, Hand, Actions) -->
                    <div id="mobile-screen-game" class="mobile-screen active">
                        <div class="panel mobile-panel">
                            <h2 class="panel-header">Game Board</h2>
                            <div class="card-container-row" data-container="board-cards"></div>
                        </div>
                        <div class="panel mobile-panel">
                             <h2 class="panel-header">Your Equipment</h2>
                             <div class="card-container-row" data-container="equipped-items"></div>
                        </div>
                        <div class="panel mobile-panel">
                            <div class="player-hand-header">
                                 <h2 class="panel-header">Your Hand</h2>
                            </div>
                            <div class="card-container-row" data-container="player-hand"></div>
                        </div>
                    </div>
    
                    <!-- Mobile Screen 2: Character (Stats, Class Selection) -->
                    <div id="mobile-screen-character" class="mobile-screen">
                        <!-- Content rendered by JS -->
                    </div>
    
                    <!-- Mobile Screen 3: Party (Player List) -->
                    <div id="mobile-screen-party" class="mobile-screen">
                         <div class="panel mobile-panel">
                            <h2 class="panel-header">Players</h2>
                            <div class="lobby-settings-display hidden" data-container="game-lobby-settings"></div>
                            <ul class="player-list" data-container="player-list"></ul>
                             <div class="lobby-controls hidden" data-container="lobby-controls">
                               <button class="btn btn-primary" data-container="start-game-btn" disabled>Start Game</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Screen 4: Info (World Events, Discoveries) -->
                     <div id="mobile-screen-info" class="mobile-screen">
                         <div class="panel mobile-panel">
                            <h2 class="panel-header">Party Discoveries</h2>
                            <div class="card-container-row" data-container="party-loot"></div>
                        </div>
                    </div>
    
                    <!-- Mobile Screen 5: Log -->
                    <div id="mobile-screen-log" class="mobile-screen">
                        <div class="panel mobile-panel" style="flex: 1; display: flex; flex-direction: column;">
                            <div class="chat-header" style="margin-bottom: 0.5rem;">
                                <h2 class="panel-header" style="margin: 0; border: none;">Chat & Log</h2>
                            </div>
                            <div class="chat-log" style="flex-grow: 1;" data-container="game-log"></div>
                            <form id="mobile-chat-form" class="chat-form" style="padding-top: 0.5rem; border-top: 1px solid var(--color-border)">
                                <select id="mobile-chat-channel" class="select-field">
                                    <option value="game">Game</option>
                                    <option value="party">Party</option>
                                </select>
                                <input type="text" id="mobile-chat-input" class="input-field" placeholder="Type..." autocomplete="off">
                                <button type="submit" class="btn btn-sm btn-primary">Send</button>
                            </form>
                        </div>
                    </div>
                </main>
    
                <div id="mobile-bottom-chrome">
                    <div class="mobile-action-bar hidden" data-container="action-bar">
                        <button class="btn btn-special btn-sm hidden" data-container="action-skill-challenge-btn">Challenge (1 AP)</button>
                        <button class="btn btn-secondary btn-sm" data-container="action-guard-btn">Guard (1AP)</button>
                        <button class="btn btn-secondary btn-sm" data-container="action-brief-respite-btn">Respite (1AP)</button>
                        <button class="btn btn-secondary btn-sm" data-container="action-full-rest-btn">Rest (2AP)</button>
                        <button class="btn btn-primary btn-sm" data-container="action-end-turn-btn">End Turn</button>
                    </div>
                    
                    <nav class="mobile-bottom-nav">
                        <button class="nav-btn active" data-screen="game"><span class="material-symbols-outlined">swords</span>Game</button>
                        <button class="nav-btn" data-screen="character"><span class="material-symbols-outlined">person</span>Character</button>
                        <button class="nav-btn" data-screen="party"><span class="material-symbols-outlined">groups</span>Party</button>
                        <button class="nav-btn" data-screen="info"><span class="material-symbols-outlined">public</span>Info</button>
                        <button class="nav-btn" data-screen="log"><span class="material-symbols-outlined">chat</span>Log</button>
                    </nav>
                </div>
            </div>
    
        </div>
        
        <!-- Shared Overlays/Modals -->
        <div id="chat-overlay" class="chat-overlay hidden">
            <div class="chat-header">
                <h2 class="panel-header">Chat & Log</h2>
                <button id="chat-close-btn" class="chat-close-btn">&times;</button>
            </div>
            <div id="chat-log" class="chat-log"></div>
            <form id="chat-form" class="chat-form">
                <select id="chat-channel" class="select-field">
                    <option value="game">Game</option>
                    <option value="party">Party</option>
                </select>
                <input type="text" id="chat-input" class="input-field" placeholder="Type..." autocomplete="off">
                <button type="submit" class="btn btn-sm btn-primary">Send</button>
            </form>
        </div>
    
        <div id="narrative-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 class="panel-header">Describe Your Action</h2>
                <p id="narrative-prompt">How do you use [Card Name]?</p>
                <textarea id="narrative-input" class="input-field" rows="3" placeholder="e.g., I chant the arcane words... (Optional)"></textarea>
                <div class="modal-actions">
                    <button id="narrative-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button id="narrative-confirm-btn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>
    
        <div id="your-turn-popup" class="your-turn-popup hidden">YOUR TURN</div>
        
        <!-- Dice Roll Modal -->
        <div id="dice-roll-modal" class="modal-overlay hidden">
            <div class="modal-content dice-roll-content">
                <h2 id="dice-roll-title" class="panel-header">Roll for Action</h2>
                <p id="dice-roll-description" class="roll-description"></p>
                <div id="dice-display-container">
                    <!-- SVG for dice will be inserted here by client.js -->
                </div>
                <div id="dice-roll-result-container" class="hidden">
                    <p id="dice-roll-result-line" class="result-line"></p>
                    <p id="dice-roll-details" class="roll-details"></p>
                    <p id="dice-roll-damage-line" class="result-line damage"></p>
                </div>
                <div class="modal-actions">
                    <button id="dice-roll-confirm-btn" class="btn btn-primary">Roll Dice</button>
                    <button id="dice-roll-close-btn" class="btn btn-secondary hidden">Close</button>
                </div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="game-over-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 id="game-over-title" class="panel-header">Game Over</h2>
                <p id="game-over-message" style="text-align: center; font-size: 1.2rem; margin-top: 1rem;"></p>
                <div class="modal-actions">
                    <button id="game-over-leave-btn" class="btn btn-primary">Return to Menu</button>
                </div>
            </div>
        </div>

        <!-- Choose to Discard Modal -->
        <div id="choose-discard-modal" class="modal-overlay hidden">
            <div class="modal-content large">
                <div class="modal-header-fixed">
                    <h2 class="panel-header">Hand is Full!</h2>
                    <p>Your hand is full. Choose a card to discard to make room for the new card.</p>
                </div>
                <div class="modal-scroll-container">
                    <div class="discard-choice-container">
                        <div class="discard-choice-section">
                            <h3>New Card</h3>
                            <div id="new-card-to-discard-container" class="card-container-row"></div>
                        </div>
                        <div class="discard-choice-section">
                            <h3>Your Hand</h3>
                            <div id="hand-cards-to-discard-container" class="card-container-row"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions modal-footer-fixed">
                    <button id="confirm-discard-btn" class="btn btn-primary" disabled>Confirm Discard</button>
                </div>
            </div>
        </div>

        <!-- Individual Discovery Modal -->
        <div id="discovery-modal" class="modal-overlay hidden">
            <div class="modal-content large">
                <div class="modal-header-fixed">
                    <h2 class="panel-header">A Fateful Choice</h2>
                    <p>You have made a new discovery, but can only carry one. Select the item you wish to keep.</p>
                </div>
                <div class="modal-scroll-container">
                    <div class="discovery-choice-container">
                        <div class="discovery-choice-section">
                            <h3>Equipped Item</h3>
                            <div id="discovery-equipped-container" class="card-container-row">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        <div class="discovery-choice-section">
                            <h3>Discovered Item</h3>
                            <div id="discovery-new-item-container" class="card-container-row">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions modal-footer-fixed">
                    <button id="discovery-confirm-btn" class="btn btn-primary" disabled>Confirm Choice</button>
                </div>
            </div>
        </div>


        <!-- Target Selection Modal (Used for Loot/Abilities) -->
        <div id="target-selection-modal" class="modal-overlay hidden">
            <div class="modal-content">
                 <div class="modal-header-fixed">
                    <h2 id="target-selection-title" class="panel-header">Select a Target</h2>
                    <p id="target-selection-prompt">Please choose a target from the list below.</p>
                </div>
                <div class="modal-scroll-container">
                    <div id="target-selection-list" class="button-grid">
                        <!-- Player buttons will be rendered here by client.js -->
                    </div>
                </div>
                <div class="modal-actions modal-footer-fixed">
                    <button id="target-selection-cancel-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Skill Challenge Modal -->
        <div id="skill-challenge-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 id="skill-challenge-title" class="panel-header">A New Challenge!</h2>
                <p id="skill-challenge-description">Details of the challenge...</p>
                <div class="modal-actions">
                     <button id="skill-challenge-decline-btn" class="btn btn-secondary">Maybe Later</button>
                     <button id="skill-challenge-resolve-btn" class="btn btn-primary">Attempt</button>
                </div>
            </div>
        </div>

        <!-- Class Selection Modal (Desktop Only) -->
        <div id="class-selection-modal" class="modal-backdrop hidden">
            <div class="modal-content">
                <h2 class="panel-header">Choose Your Destiny</h2>
                <p>Please select a class to begin your Quest & Chronicle.</p>
                <div id="desktop-class-card-display">
                    <!-- Class cards will be rendered here by client.js -->
                </div>
                <div class="modal-actions">
                    <button id="confirm-class-selection-btn" class="btn btn-primary" disabled>Confirm Class</button>
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="help-modal" class="modal-overlay hidden">
            <div class="modal-content help-modal-content">
                <div class="help-header">
                    <h2 class="panel-header">Game Guide</h2>
                    <button id="help-close-btn" class="btn btn-icon btn-sm" style="background: none; border: none; font-size: 1.5rem;">&times;</button>
                </div>
                <div id="help-content" class="help-content">
                    <!-- Pages will be rendered here -->
                </div>
                <div class="help-navigation">
                    <button id="help-prev-btn" class="btn btn-secondary">Previous</button>
                    <span id="help-page-indicator">Page 1 / 7</span>
                    <button id="help-next-btn" class="btn btn-secondary">Next</button>
                </div>
            </div>
        </div>
        
        <!-- Game Paused Modal -->
        <div id="game-paused-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2 class="panel-header">Game Paused</h2>
                <p id="game-paused-reason" style="text-align: center; font-size: 1.2rem; margin-top: 1rem;"></p>
            </div>
        </div>
    
    </div>
    <div id="toast-container"></div>
    <div id="animation-overlay"></div>
    <div id="voice-chat-audio-container"></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/client.js"></script>
</body>
</html>